<script type="text/javascript">


	$(document).ready(function () {

		var importEnabledMsg = '<p><strong>Note</strong>: Loading this page causes legacy data to be imported. The console should show import results. A large import may take several minutes and this simple importer doesn\'t provide any user feedback, so just be careful not to close the browser tab early. Disable the import code in SiteAssets > wpc_importer.html.</p>';
		var importDisabledMsg = '<p><strong>Note</strong>: Import code has been disabled. You can re-enable in SiteAssets > wpc_import.html.</p>';




		$('div#DeltaPlaceHolderMain').append(importDisabledMsg);



		// to enable import, remove /**/ and comment out disable section


		console.log('m1');

		$('div#all-content-container').append(importEnabledMsg);


		  // partial config 
		/*var mData = {
			'legacyFile': '/sites/gpc-submission/SiteAssets/submissionRequests.xml', //https://bmos.sharepoint.com
			'maxToProcess': 10000,
			'newList': 'SWFList',
			'deleteAllItemsBeforeImporting': 1,
			'emailErrorsTo': 'jbaker@mos.org'
		}

		// delete all list items, if configured to do so
		if (typeof (mData.deleteAllItemsBeforeImporting) != 'undefined' && mData.deleteAllItemsBeforeImporting == 1) {
			$().SPServices.SPUpdateMultipleListItems({
				//webURL: "",
				listName: mData.newList,
				//CAMLQuery: "",
				batchCmd: "Delete",
				//valuepairs: [],
				debug: false,
				completefunc: null
			});
		}

		// get the legacy requests file
		$.ajax({
			type: "GET",
			url: mData.legacyFile,
			dataType: "xml",
		}).done(function (receivedXML) {

			// iterate over each legacy request
			$(receivedXML).find('request').each(function (requestIndex, requestValue) {

				// if we haven't surpassed the max to process
				if (requestIndex < mData.maxToProcess) {

					// set up empty vars
					var listFields = {};
					var submissionValuePairs = [];

					// set some other values
					var exEmployees = [
						"pkirschmann@mos.org",
						"kgilligan@mos.org",
						"eohara@mos.org",
						"abaff@mos.org"
					];

					var nameReplacements = [
						{
							"input": "Katie Todd (TEMP)",
							"output": ""
						}, {
							"input": "Dani LeBlanc / Jason Fletcher",
							"output": ["Dani LeBlanc", "Jason Fletcher"]
						}, {
							"input": "Dani LeBlanc, Talia Sepersky",
							"output": ["Dani LeBlanc", "Talia Sepersky"]
						}, {
							"input": "Katie Todd (TEMP)",
							"output": ""
						},{
							"input": "Peter Blake (BU)",
							"output": ""
						}, {
							"input": "Liz Kollmann (for MOS)",
							"output": "Liz Kunz Kollmann"
						}, {
							"input": "Liz Kollmann",
							"output": "Liz Kunz Kollmann"
						}, {
							"input": "Liz Kollman (for MOS)",
							"output": "Liz Kunz Kollmann"
						}, {
							"input": "Liz Kollman",
							"output": "Liz Kunz Kollmann"
						}, {
							"input": "Liz Kong (for MOS)",
							"output": "Elizabeth Kong"
						}, {
							"input": "Becki Kipling (for MOS)",
							"output": "Becki Kipling"
						}, {
							"input": "Becki Kipling and Katie Todd",
							"output": "Becki Kipling"
						}, {
							"input": "Dani LeBlanc/Jason Fletcher",
							"output": ["Dani LeBlanc", "Jason Fletcher"]
						}, {
							"input": "ASTC",
							"output": ""
						}, {
							"input": "Katie Gilligan",
							"output": ""
						}, {
							"input": "Nina Svarovsky of Notre Dame ",
							"output": "Lydia Beall"
						}, {
							"input": "Lydia Beall (for MOS)",
							"output": "Lydia Beall"
						}, {
							"input": "Lawrence Bell",
							"output": "Larry Bell"
						}
					];


					var emailReplacements = [
						{
							"input": "kgilligan@mos.org",
							"output": ""
						}, {
							"input": "pkirschmann@mos.org",
							"output": ""
						}, {
							"input": "rkipling@mos.org; ktodd@mos.org",
							"output": "rkipling@mos.org"
						}, {
							"input": "ktodd@mos.org",
							"output": ""
						}, {
						    "input": "ekollman@mos.org",
						    "output": "ekollmann@mos.org"
						// }, {
						//     "input": "",
						//     "output": ""
						// }, {
						//     "input": "",
						//     "output": []
						}
					];

					// grab some data that will be used multiple times, that needs to be manipulated, or is otherwise convenient
					var legacyID = $(requestValue).find('legacyID').text();
					var quarkRequest = 'https://quark.mos.org/getitdone/GPC2/final/form.cfm?propID=' + legacyID;




					var requestDate = $(requestValue).find('requestDate').text();
					if (requestDate != "" && moment(requestDate).isValid()) {
						requestDate = moment(requestDate.substr(0, 10)).format("YYYY-MM-DD");
						requestDate = requestDate + 'T12:00:00-04:00';
					} else {
						requestDate = "";
					}

					var proposalDueDate = $(requestValue).find('proposalDueDate').text();
					// console.log(legacyID);
					if (proposalDueDate != "" && moment(proposalDueDate).isValid()) {
						proposalDueDate = moment(proposalDueDate.substr(0, 10)).format("YYYY-MM-DD");
						proposalDueDate = proposalDueDate + 'T12:00:00-04:00';
						// console.log("proposalDueDate");
						// console.log(proposalDueDate);
					} else {
						proposalDueDate = "";
					}
					
					var submissionDate = $(requestValue).find('submissionDate').text();
					if (submissionDate != "" && moment(submissionDate).isValid()) {
						submissionDate = moment(submissionDate.substr(0, 10)).format("YYYY-MM-DD");
						submissionDate = submissionDate + 'T12:00:00-04:00';
					} else {
						submissionDate = "";
					}
					
					var expectedDecisionDate = $(requestValue).find('expectedDecisionDate').text();
					if (expectedDecisionDate != "" && moment(expectedDecisionDate).isValid()) {
						expectedDecisionDate = moment(expectedDecisionDate.substr(0, 10)).format("YYYY-MM-DD");
						expectedDecisionDate = expectedDecisionDate + 'T12:00:00-04:00';
					} else {
						expectedDecisionDate = "";
					}
					





					var financeDate = $(requestValue).find('financeDate').text();
					if (financeDate != "" && moment(financeDate).isValid()) {
						financeDate = moment(financeDate.substr(0, 10)).format("MMMM D, YYYY");
						financeDate = financeDate;
					} else {
						financeDate = "";
					}
					
					var siDate = $(requestValue).find('siDate').text();
					if (siDate != "" && moment(siDate).isValid()) {
						siDate = moment(siDate.substr(0, 10)).format("MMMM D, YYYY");
						siDate = siDate;
					} else {
						siDate = "";
					}
					
					var edcDate = $(requestValue).find('edcDate').text();
					if (edcDate != "" && moment(edcDate).isValid()) {
						edcDate = moment(edcDate.substr(0, 10)).format("MMMM D, YYYY");
						edcDate = edcDate;
					} else {
						edcDate = "";
					}
					
					var advDate = $(requestValue).find('advDate').text();
					if (advDate != "" && moment(advDate).isValid()) {
						advDate = moment(advDate.substr(0, 10)).format("MMMM D, YYYY");
						advDate = advDate;
					} else {
						advDate = "";
					}
					
					var dimDate = $(requestValue).find('dimDate').text();
					if (dimDate != "" && moment(dimDate).isValid()) {
						dimDate = moment(dimDate.substr(0, 10)).format("MMMM D, YYYY");
						dimDate = dimDate;
					} else {
						dimDate = "";
					}







					var primaryInvestigatorName = $.trim($(requestValue).find('primaryInvestigatorFullName').text());
					primaryInvestigatorName = ReturnNameOrReplacement(nameReplacements, primaryInvestigatorName);
					var coInvestigatorName = $.trim($(requestValue).find('coInvestigatorFullName').text());
					coInvestigatorName = ReturnNameOrReplacement(nameReplacements, coInvestigatorName);
					var proposalDeveloperName = $.trim($(requestValue).find('proposalDeveloperFullName').text());
					proposalDeveloperName = ReturnNameOrReplacement(nameReplacements, proposalDeveloperName);
					// console.log(primaryInvestigatorName);
					// console.log(coInvestigatorName);
					// console.log(proposalDeveloperName);






					var primaryInvestigatorEmail = $.trim($(requestValue).find('primaryInvestigatorEmail').text());
					primaryInvestigatorEmail = ReturnEmailOrReplacement(emailReplacements, primaryInvestigatorEmail);
					var coInvestigatorEmail = $.trim($(requestValue).find('coInvestigatorEmail').text());
					coInvestigatorEmail = ReturnEmailOrReplacement(emailReplacements, coInvestigatorEmail);
					var proposalDeveloperEmail = $.trim($(requestValue).find('proposalDeveloperEmail').text());
					proposalDeveloperEmail = ReturnEmailOrReplacement(emailReplacements, proposalDeveloperEmail);

					if (legacyID == "1374") {
						proposalDeveloperEmail = ["dleblanc@mos.org", "jfletcher@mos.org"];
					}

					if (legacyID == "1373") {
						proposalDeveloperEmail = ["dleblanc@mos.org", "tsepersky@mos.org"];
					}


					
					// console.log(legacyID);
					// if (primaryInvestigatorName !== "Gail Breslow" && primaryInvestigatorName !== "Christine Reich"
					// 	&& primaryInvestigatorName !== "David Sittenfeld" && primaryInvestigatorName !== "Becki Kipling" 
					// 	&& primaryInvestigatorName !== "Lesley Kennedy" && primaryInvestigatorName !== "Lydia Beall" && primaryInvestigatorName !== "") {
					// 	console.log(primaryInvestigatorName);
					// 	console.log(primaryInvestigatorEmail);
					// 	// console.log(typeof(primaryInvestigatorEmail));
					// }
					
					// if (coInvestigatorName !== "Gail Breslow" && coInvestigatorName !== "Christine Reich"
					// 	&& coInvestigatorName !== "David Sittenfeld" && coInvestigatorName !== "Becki Kipling"
					// 	&& coInvestigatorName !== "Lesley Kennedy" && coInvestigatorName !== "Lydia Beall" && coInvestigatorName !== "") {
					// 	console.log(coInvestigatorName);
					// 	console.log(coInvestigatorEmail);
					// 	// console.log(typeof (coInvestigatorEmail));
					// }
					
					// if (proposalDeveloperName !== "Gail Breslow" && proposalDeveloperName !== "Christine Reich"
					// 	&& proposalDeveloperName !== "David Sittenfeld" && proposalDeveloperName !== "Becki Kipling"
					// 	&& proposalDeveloperName !== "Lesley Kennedy" && proposalDeveloperName !== "Lydia Beall" && proposalDeveloperName !== "") {
					// 	console.log(proposalDeveloperName);
					// 	console.log(proposalDeveloperEmail);
					// 	// console.log(typeof (proposalDeveloperEmail));
					// }
					












					var requestedForAccount = $(requestValue).find('requestedForAccount').text();
					var requestedForName = "";

					if (requestedForAccount != "" && ReturnThisEmployeeIsNOTEx(exEmployees, requestedForAccount + '@mos.org')) {
						var requestedForData = ReturnUserDataUsingAccountName('i:0#.f|membership|' + requestedForAccount + '@mos.org');
					}

					if (typeof(requestedForData) != "undefined" && typeof(requestedForData.name) != "undefined" && requestedForData.name != "") {
						requestedForName = requestedForData.name;
					}
					




					
					var narrativeFileName = $(requestValue).find('projectNarrativeFileName').text();
					var narrativeFileSizeToReport = ReturnFileSizeToReport($(requestValue).find('projectNarrativeFileSize').text());
					var narrativeFileType =  ReturnFileTypeClass(narrativeFileName);

					var budgetFileName = $(requestValue).find('projectBudgetFileName').text();
					var budgetFileSizeToReport = ReturnFileSizeToReport($(requestValue).find('projectBudgetFileSize').text());
					var budgetFileType =  ReturnFileTypeClass(budgetFileName);









					var mosDirectCostsFormatted = ReturnCurrencyStringFormatted($(requestValue).find('mosDirectCosts').text());
					var idcFormatted = ReturnCurrencyStringFormatted($(requestValue).find('idc').text());
					var totalProjectBudgetFormatted = ReturnCurrencyStringFormatted($(requestValue).find('totalProjectBudget').text());
					var totalMOSBudgetFormatted = ReturnCurrencyStringFormatted($(requestValue).find('totalMOSBudget').text());
					var costShareFormatted = ReturnCurrencyStringFormatted($(requestValue).find('costShare').text());

					// var gpcApprovalSignature = $.trim($(requestValue).find('gpcApprovalSignature').text());
					// if (gpcApprovalSignature == "b") {
					// 	gpcApprovalSignature = "BarB Harvey";
					// }



					


					var legacyRSFlag = $(requestValue).find('approved').text();

					// Finance
					var financeApproval = $(requestValue).find('financeApprovalIndicator').text();
					// Strat Proj
					var spApproval = $(requestValue).find('siApprovalIndicator').text();
					// EDC
					var edcApproval = $(requestValue).find('edcApprovalIndicator').text();
					// Adv
					var advApproval = $(requestValue).find('advApprovalIndicator').text();
					// IIT
					var iitApproval = $(requestValue).find('dimApprovalIndicator').text();




					var requestStatus = "";
					var endOfLife = "0";
					
					// if it hasn't been submitted
					if (legacyRSFlag == "0" && submissionDate == "") {
						requestStatus = "In Development";
					// if it's been submitted but not approved
					} else if (legacyRSFlag == "0" && submissionDate != "") {
						// if anyone has marked it "approval withheld"
						if (financeApproval == "0" || spApproval == "0" || edcApproval == "0" || advApproval == "0" || iitApproval == "0") {
							requestStatus = "Approval Pending Comments";
						// if no one has marked it "approvel withheld"
						} else {
							requestStatus = "Pending Approval";
						}
					// if it's been approved
					} else if (legacyRSFlag == "1") {
						requestStatus = "Grant Proposal Ready for Submission";
					} 




					// manually set some basic list fields for this item
					listFields.LegacyID = HtmlEncode(legacyID);
					listFields.BeginningOfLife = HtmlEncode('0');
					listFields.NewlyApprovedOrPending = HtmlEncode('0');
					listFields.ApprovalNewlyNeededNotify = HtmlEncode('none');
					listFields.ApprovalNotNeededNotify = HtmlEncode('none');
					listFields.ApprovalStillNeededNotify = HtmlEncode('none');
					listFields.SWFVersion = HtmlEncode('1.0');
					listFields.RequestVersion = HtmlEncode('1');
					listFields.RequestName = HtmlEncode('GPC Submission Approval');
				  
					



					// manually set some allRequestData properties
					var allRequestData = '{"RepeatedElements": [],' +
						'"migrated-from-quark": "1",' +
      					'"id-or-link_GPC-Initial-Concept-Approval-Request-ID": "0",' +
						'"Beginning-of-Life": "0",' +
						'"Approval-Newly-Needed-Notify": "none",' +
						'"Approval-Not-Needed-Notify": "none",' +
						'"Approval-Still-Needed-Notify": "none",' +
						'"Newly-Approved-or-Pending": "0",' +
						'"Last-Modified-Timestamp-Mismatch": "0",' +
						'"Admin-Email": "sp1@mos.org;jbaker@mos.org;sp2@mos.org;sp10@mos.org;sp12@mos.org;sp11@mos.org;sp14@mos.org;sp13@mos.org;tcutler@BMOS.onmicrosoft.com",'
						'"Request-Name": "GPC Submission Approval",' +
						'"SWF-Version": "1.0",' +
						'"Request-Version": "1",' +
						'"Component-Group-Admin": "6;#James Baker,#i:0#.f|membership|jbaker@mos.org,#jbaker@mos.org,#jbaker@mos.org,#James Baker,#https://bmos-my.sharepoint.com:443/User%20Photos/Profile%20Pictures/jbaker_mos_org_MThumb.jpg,#Interactive Media,#Intranet Solutions Project Manager;#20;#Ben Wilson,#i:0#.f|membership|bwilson@mos.org,#bwilson@mos.org,#bwilson@mos.org,#Ben Wilson,#https://bmos-my.sharepoint.com:443/User%20Photos/Profile%20Pictures/bwilson_mos_org_MThumb.jpg,#Interactive Media,#Interactive Media Manager",' +
						'"Component-Admin": "586;#James Paone,#i:0#.f|membership|jpaone@mos.org,#jpaone@mos.org,#jpaone@MOS.ORG,#James Paone,#https://bmos-my.sharepoint.com:443/User%20Photos/Profile%20Pictures/jpaone_mos_org_MThumb.jpg,#Interactive Media,#Audio Visual Technician;#587;#Kyle Rasmussen,#i:0#.f|membership|krasmussen@mos.org,#krasmussen@mos.org,#krasmussen@MOS.ORG,#Kyle Rasmussen,#https://bmos-my.sharepoint.com:443/User%20Photos/Profile%20Pictures/krasmussen_mos_org_MThumb.jpg,#Interactive Media,#Technical Services Coordinator;#145;#Joseph Rivers,#i:0#.f|membership|jrivers@mos.org,#jrivers@mos.org,#jrivers@mos.org,#Joseph Rivers,#https://bmos-my.sharepoint.com:443/User%20Photos/Profile%20Pictures/jrivers_mos_org_MThumb.jpg,#Interactive Media,#Coordinator,, AV Production",' +
						'"Current-User-Name": "jbaker@mos.org",' +
						'"Current-User-is-Admin": "0",' +
						'"Current-User-is-Component-Group-Admin": "0",' +
						'"Current-User-Display-Name": "James Baker",' + 
						'"Component-ID": "155",' +
						'"concept-request_yes": "yes",' +
						'"Self-or-Other": "Talk to me",';





					
					
					
					
					
					
					
					// dynamically set all remaining basic list fields
					if (primaryInvestigatorEmail !== "") { //  && ReturnThisEmployeeIsNOTEx(exEmployees, primaryInvestigatorEmail)
						listFields.MOSPrincipalInvestigator = HtmlEncode(ReturnPeopleListFieldValue(primaryInvestigatorEmail));
					}
					if (coInvestigatorEmail !== "") { //  && ReturnThisEmployeeIsNOTEx(exEmployees, coInvestigatorEmail)
						listFields.MOSCoInvestigator = HtmlEncode(ReturnPeopleListFieldValue(coInvestigatorEmail));
					}
					if (proposalDeveloperEmail !== "") { //  && ReturnThisEmployeeIsNOTEx(exEmployees, proposalDeveloperEmail)
						listFields.ProposalDeveloper = HtmlEncode(ReturnPeopleListFieldValue(proposalDeveloperEmail));
					}
					if (requestedForAccount !== "" && ReturnThisEmployeeIsNOTEx(exEmployees, requestedForAccount + '@mos.org')) { //  && ReturnThisEmployeeIsNOTEx(exEmployees, requestedForAccount + '@mos.org')
						listFields.RequestedFor = HtmlEncode('-1;#' + requestedForAccount + '@mos.org');
					}

					

					listFields.RequestDate = requestDate;
					listFields.ProposalDueDate = proposalDueDate;
					listFields.SubmissionDate = submissionDate;


					// console.log("about to record: " + requestStatus);
					listFields.RequestStatus = requestStatus;
					// console.log(listFields.RequestStatus + " is going in");
					// console.log("");


					listFields.Title = HtmlEncode(moment(requestDate).format("YYYY-MM-DD") + ' - ' + $(requestValue).find('projectTitle').text());
					listFields.ProjectTitle = HtmlEncode($(requestValue).find('projectTitle').text());

					listFields.EndOfLife = HtmlEncode(endOfLife);

					listFields.Funder = HtmlEncode($(requestValue).find('funder').text());



					




















					// dynamically set all remaining allRequestData properties
					allRequestData += 
						'"End-of-Life":"' + listFields.EndOfLife + '",' +
						'"Request-Nickname":"' + listFields.Title + '",' +
						'"Project-Title":"' + listFields.ProjectTitle + '",' +
						'"Funder":"' + listFields.Funder + '",' +
					
						// '"XXX":"' + listFields.XXX + '",' +
						// '"XXX":"' + listFields.XXX + '",' +
						// '"XXX":"' + listFields.XXX + '",' +
						// '"XXX":"' + listFields.XXX + '",' +
						// '"XXX":"' + listFields.XXX + '",' +
						// '"XXX":"' + listFields.XXX + '",' +
						// '"XXX":"' + listFields.XXX + '",' +
						// '"XXX":"' + listFields.XXX + '",' +




						'"Request-Status":"' + requestStatus + '",' + 
						'"Request-Status-2":"' + requestStatus + '",' + 
						'"Proposal-Type":"' + HtmlEncode($(requestValue).find('proposalType').text()) + '",' + 

						'"MOS-Direct-Costs":"' + HtmlEncode(mosDirectCostsFormatted) + '",' +
						'"IDC":"' + HtmlEncode(idcFormatted) + '",' +

						'"Total-Project-Budget":"' + HtmlEncode(totalProjectBudgetFormatted) + '",' +
						'"Total-MOS-Budget":"' + HtmlEncode(totalMOSBudgetFormatted) + '",' +
						'"Cost-Share":"' + HtmlEncode(costShareFormatted) + '",' +





						'"PID-Comments":"' + HtmlEncode($(requestValue).find('pidComments').text()) + '",' +
						'"Submission-Signature":"' + HtmlEncode($(requestValue).find('submissionSignature').text()) + '",' +


						// '"GPC-Comments":"' + HtmlEncode($(requestValue).find('gpcComments').text()) + '",' +
						// '"Approval-Signature":"' + HtmlEncode(gpcApprovalSignature) + '",' +
						
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						// '"XXX":"' + HtmlEncode($(requestValue).find('XXX').text()) + '",' +
						
						
						
						
                        '"Quark-Request":"' + HtmlEncode(quarkRequest) + '",' +
                        '"legacy-id":"' + legacyID + '",';





















					if (requestedForAccount != "" && requestedForName != "" && ReturnThisEmployeeIsNOTEx(exEmployees, requestedForAccount + '@mos.org')) {
						allRequestData += '"Requested-For": ' + ReturnPeopleAllRequestDataValue(requestedForName, requestedForAccount + "@mos.org") + ',';
					}
					
					if (primaryInvestigatorEmail != "" && ReturnThisEmployeeIsNOTEx(exEmployees, primaryInvestigatorEmail)) {
						allRequestData += '"MOS-Principal-Investigator": ' + ReturnPeopleAllRequestDataValue(primaryInvestigatorName, primaryInvestigatorEmail) + ',';
					}
					
					if (coInvestigatorEmail != "" && ReturnThisEmployeeIsNOTEx(exEmployees, coInvestigatorEmail)) {
						allRequestData += '"MOS-Co-Investigator": ' + ReturnPeopleAllRequestDataValue(coInvestigatorName, coInvestigatorEmail) + ',';
					}

					if (proposalDeveloperEmail != "" && ReturnThisEmployeeIsNOTEx(exEmployees, proposalDeveloperEmail)) {
						allRequestData += '"Proposal-Developer": ' + ReturnPeopleAllRequestDataValue(proposalDeveloperName, proposalDeveloperEmail) + ',';
					}

					if (narrativeFileName != "") {
						allRequestData += '"mos-drag-and-drop-file-name_Project-Narrative-File":"' + HtmlEncode('description/' + narrativeFileName) + '",';
						allRequestData += '"mos-drag-and-drop-file-size_Project-Narrative-File":"' + HtmlEncode(narrativeFileSizeToReport) + '",';
						allRequestData += '"mos-drag-and-drop-file-type-class_Project-Narrative-File":"' + HtmlEncode(narrativeFileType) + '",';
						allRequestData += '"mos-drag-and-drop-file-in-quark-files_Project-Narrative-File":"1",';
					}
					
					if (budgetFileName != "") {
						allRequestData += '"mos-drag-and-drop-file-name_Project-Budget-File":"' + HtmlEncode('timeline/' + budgetFileName) + '",';
						allRequestData += '"mos-drag-and-drop-file-size_Project-Budget-File":"' + HtmlEncode(budgetFileSizeToReport) + '",';
						allRequestData += '"mos-drag-and-drop-file-type-class_Project-Budget-File":"' + HtmlEncode(budgetFileType) + '",';
						allRequestData += '"mos-drag-and-drop-file-in-quark-files_Project-Budget-File":"1",';
					}
					
					if ($(requestValue).find('museumIsSubawardee').text() == "1") {
						allRequestData += '"museum-role_subawardee": "subawardee",';
						allRequestData += '"Prime-Institution": "Not provided on Quark.",';
					}

					if ($(requestValue).find('museumIsSubawardee').text() == "0") {
						allRequestData += '"museum-role_primerecipient": "primeRecipient",';
					}

					

					if (expectedDecisionDate != "") {
						allRequestData += '"Expected-Decision-Date":"' + expectedDecisionDate + '",';
						allRequestData += '"expected-decision-date-boolean_yes":"yes",';
					} else {
						allRequestData += '"expected-decision-date-boolean_no":"no",';
					}

					if (requestDate != "") {
						allRequestData += '"Request-Date":"' + listFields.RequestDate + '",';
					}

					if (proposalDueDate != "") {
						allRequestData += '"Proposal-Due-Date":"' + listFields.ProposalDueDate + '",';
					}

					if (submissionDate != "") {
						allRequestData += '"Submission-Date":"' + listFields.SubmissionDate + '",';
					}


					


					if (financeApproval == "1") {
						allRequestData += '"approval-indicator---finance_approve": "approve",';
					}
					if (financeApproval == "0") {
						allRequestData += '"approval-indicator---finance_needinfo": "needInfo",';
					}

					if (spApproval == "1") {
						allRequestData += '"approval-indicator---logistics_approve": "approve",';
					}
					if (spApproval == "0") {
						allRequestData += '"approval-indicator---logistics_needinfo": "needInfo",';
					}

					if (edcApproval == "1") {
						allRequestData += '"approval-indicator---edc_approve": "approve",';
					}
					if (edcApproval == "0") {
						allRequestData += '"approval-indicator---edc_needinfo": "needInfo",';
					}

					if (advApproval == "1") {
						allRequestData += '"approval-indicator---cfg_approve": "approve",';
					}
					if (advApproval == "0") {
						allRequestData += '"approval-indicator---cfg_needinfo": "needInfo",';
					}

					if (iitApproval == "1") {
						allRequestData += '"approval-indicator---dim_approve": "approve",';
					}
					if (iitApproval == "0") {
						allRequestData += '"approval-indicator---dim_needinfo": "needInfo",';
					}








					if (financeDate != "") {
						allRequestData += '"Approval-Date---Finance":"' + financeDate + '",';
					}

					if (siDate != "") {
						allRequestData += '"Approval-Date---Logistics":"' + siDate + '",';
					}

					if (edcDate != "") {
						allRequestData += '"Approval-Date---EDC":"' + edcDate + '",';
					}

					if (advDate != "") {
						allRequestData += '"Approval-Date---CFG":"' + advDate + '",';
					}

					if (dimDate != "") {
						allRequestData += '"Approval-Date---DIM":"' + dimDate + '",';
					}



					if ($(requestValue).find('financeComments').text() != "") {
						allRequestData += '"Approval-Notes---Finance":"' + HtmlEncode($(requestValue).find('financeComments').text()) + '",';
					}

					if ($(requestValue).find('siComments').text() != "") {
						allRequestData += '"Approval-Notes---Logistics":"' + HtmlEncode($(requestValue).find('siComments').text()) + '",';
					}

					if ($(requestValue).find('edcComments').text() != "") {
						allRequestData += '"Approval-Notes---EDC":"' + HtmlEncode($(requestValue).find('edcComments').text()) + '",';
					}

					if ($(requestValue).find('advComments').text() != "") {
						allRequestData += '"Approval-Notes---CFG":"' + HtmlEncode($(requestValue).find('advComments').text()) + '",';
					}

					if ($(requestValue).find('dimComments').text() != "") {
						allRequestData += '"Approval-Notes---DIM":"' + HtmlEncode($(requestValue).find('dimComments').text()) + '",';
					}

					if ($(requestValue).find('otherReviewersComments').text() != "") {
						allRequestData += '"Other-Reviewer-Comments":"' + HtmlEncode($(requestValue).find('otherReviewersComments').text()) + '",';
					}



					if ($(requestValue).find('financeSignature').text() != "") {
						allRequestData += '"Approval-Signature---Finance":"' + HtmlEncode($(requestValue).find('financeSignature').text()) + '",';
					}

					if ($(requestValue).find('siSignature').text() != "") {
						allRequestData += '"Approval-Signature---Logistics":"' + HtmlEncode($(requestValue).find('siSignature').text()) + '",';
					}

					if ($(requestValue).find('edcSignature').text() != "") {
						allRequestData += '"Approval-Signature---EDC":"' + HtmlEncode($(requestValue).find('edcSignature').text()) + '",';
					}

					if ($(requestValue).find('advSignature').text() != "") {
						allRequestData += '"Approval-Signature---CFG":"' + HtmlEncode($(requestValue).find('advSignature').text()) + '",';
					}

					if ($(requestValue).find('dimSignature').text() != "") {
						allRequestData += '"Approval-Signature---DIM":"' + HtmlEncode($(requestValue).find('dimSignature').text()) + '",';
					}






					if ($(requestValue).find('edcStaffNegotiated').text() == "0") {
						allRequestData += '"edc-needs_yes": "yes",';
					}

					if ($(requestValue).find('edcStaffNames').text() == "0") {
						allRequestData += '"EDC-Staff-Member-Names": "' + HtmlEncode($(requestValue).find('edcStaffNames').text()) + '",';
					}

					if ($(requestValue).find('dimStaffNegotiated').text() == "0") {
						allRequestData += '"web-needs_yes": "yes",';
					}

					if ($(requestValue).find('rAndENegotiated').text() == "0") {
						allRequestData += '"re-needs_yes": "yes",';
					}

					if ($(requestValue).find('irbNegotiated').text() == "0") {
						allRequestData += '"irb-needs_yes": "yes",';
					}

					if ($(requestValue).find('newStaffPositionsRequired').text() == "0") {
						allRequestData += '"new-staff-needs_yes": "yes",';
					}

					if ($(requestValue).find('newStaffPositionsWhat').text() == "0") {
						allRequestData += '"New-Staff-Positions": "' + HtmlEncode($(requestValue).find('newStaffPositionsWhat').text()) + '",';
					}

					if ($(requestValue).find('newOfficeSpaceRequired').text() == "0") {
						allRequestData += '"office-space-needs_yes": "yes",';
					}

					if ($(requestValue).find('newOfficeSpaceHowMany').text() == "0") {
						allRequestData += '"Staff-Quantity-for-Office-Space": "' + HtmlEncode($(requestValue).find('newOfficeSpaceHowMany').text()) + '",';
					}
































					// finish off allRequestData
					allRequestData += '}';





					if (legacyID === "1387") {
						listFields.ProposalDeveloper = "";
					}









					// construct value pairs from listFields and allRequestData
					//  (this could be skipped by just pushing above instead of setting obj props,
					//      but James is dyslexic and this helps)
					for (var key in listFields) {
						submissionValuePairs.push([key, listFields[key]]);
					}
					submissionValuePairs.push(["AllRequestData", CDataWrap(allRequestData)]);

					

					// console.log(submissionValuePairs);


					// send value pairs to SPServices UpdateListItems to create a new item in the new list
					 $().SPServices({
						operation: 'UpdateListItems',
						listName: mData.newList,
						batchCmd: 'New',
						ID: 0,
						valuepairs: submissionValuePairs,
						completefunc: function (xData, Status) {
							var errorCode = $(xData.responseXML).find('ErrorCode').text();
							if (errorCode != '0x00000000') {
								if (errorCode == '') { errorCode = '""'; }
								console.log('errorCode = ' + errorCode);
								console.log('legacyID = ' + $(requestValue).find('legacyID').text());
								// console.log('submissionValuePairs');
								console.log(submissionValuePairs);
								console.log("");
								//var emailBody = 'error = ' + errorCode + '; legacy ID = ' + $(requestValue).find('legacyID').text() + '; name = ' + lastName + ', ' + firstName;
								//SendErrorEmail('noreply@mos.org', emailErrorsTo, emailBody, 'Hub migration error: ' + errorCode)
							} else if (Status == 'Error') {
								console.log('Status = Error');
								console.log('legacyID = ' + $(requestValue).find('legacyID').text());
								// console.log('submissionValuePairs');
								console.log(submissionValuePairs);
								console.log("");
							} else {
								var newRequestID = $(xData.responseXML).SPFilterNode("z:row").attr("ows_ID");
								console.log('legacyID ' + legacyID + ' is requestID = ' + newRequestID);
								console.log('submissionValuePairs');
								console.log(submissionValuePairs);
								console.log("");
							}
						}
					});
				}
			});
		}).error(function () {
			alert("An error occurred while getting the XML file.");
		});


		// !!! ---- end import-disabling comment here ---- !!!


		

	}); */



	function GetFieldsFromOneRow (options) {

		var returnValue = {};

		// assume we're going to query this site's SWFList if a specific list wasn't supplied
		var opt = $.extend({}, {
			listName: "SWFList",
			completefunc: null
		}, options);

		// if listname is component log or component group log and no webURL was supplied
		if ((opt.listName === 'ComponentLog' || opt.listName === 'Component Group Log') && typeof (options.webURL) === 'undefined') {
			// assume HubProd
			opt.webURL = 'https://bmos.sharepoint.com/sites/hubprod';
		}

		var query = "<Query>" +
						"<Where>" +
							"<Eq>" +
								"<FieldRef Name='" + opt.where.field + "'></FieldRef>" +
								"<Value Type='" + opt.where.type + "'>" + opt.where.value + "</Value>" +
							"</Eq>" +
						"</Where>" +
					"</Query>";

		var fields = "<ViewFields>";
		$.each(opt.select, function (i, oneField) {
			fields += "<FieldRef Name='" + oneField.nameInList + "' />";
		});
		fields += "</ViewFields>";


		$().SPServices({
			operation: "GetListItems",
			async: false,
			webURL: opt.webURL,
			listName: opt.listName,
			CAMLViewFields: fields,
			CAMLQuery: query,
			CAMLQueryOptions: "<QueryOptions />",
			completefunc: function (xData, Status) {
				$(xData.responseXML).SPFilterNode("z:row").each(function () {
					var zRow = $(this);

					$.each(opt.select, function (i, oneField) {

						if (oneField.nameHere === "formData" || oneField.nameHere === "defaultDataForNewRequests") {

							var value = $(zRow).attr("ows_" + oneField.nameInList);

							var regexOne = new RegExp("\r", "g");
							var regexTwo = new RegExp("\n", "g");
							value = value.replace(regexOne, "'");
							value = value.replace(regexTwo, "'");

							eval("var formDataObj=" + value);

							returnValue[oneField.nameHere] = formDataObj;

						} else {

							value = $(zRow).attr("ows_" + oneField.nameInList);

							if (typeof (oneField.linkField) != "undefined") {
								if (oneField.linkField === 1) {
									
									value = ReplaceAll(",,", "DOUBLECOMMAREPLACEMENT", value);
									value = value.split(",")[0];
									value = ReplaceAll("DOUBLECOMMAREPLACEMENT", ",", value);
								}
							}
							returnValue[oneField.nameHere] = value;
						}
					});
				});
			}
		});

		return returnValue;
	}









 
	/*function GetAndAttachFile (fileName, filePathAndName, newRequestID) {
		fetch(filePathAndName)
		.then(function(res) {
				
			res.arrayBuffer()
			.then(function (buffer) {

				var binary = "";
				var bytes = new Uint8Array(buffer);
				var i = bytes.byteLength;

				// convert it to binary
				while (i--) {
					binary = String.fromCharCode(bytes[i]) + binary;
				}

				// attempt to attach to the request (the SP list item)
				$().SPServices({
					operation: "AddAttachment",
					listName: "SWFList",
					listItemID: newRequestID,
					fileName: fileName,
					attachment: btoa(binary),
					completefunc: function (xData, Status) {

						// determine the success of the attempt
						var attachmentSaveSuccess = $().HandleListUpdateReturn(xData, Status, 'Hub Attachment Error');

						// if unsuccessful
						if (attachmentSaveSuccess != 1) {
							console.log("attachment problem");
							console.log(xData);
							console.log(Status);
						// if successful
						} else {
							console.log("attachment success");
						}
					}
				});

			});






		});
	}

	function GetFileBuffer (file) {

		var deferred = $.Deferred();
		var reader = new FileReader();

		reader.onload = function(e) {
			deferred.resolve(e.target.result);
		}

		reader.onerror = function(e) {
			deferred.reject(e.target.error);
		}

		reader.readAsArrayBuffer(file);

		return deferred.promise();
	}; */
    
    function ReturnUserDataUsingAccountName (accountName) {
        var userData = {};

        $().SPServices({
            operation: "GetUserProfileByName",
            async: false,
            AccountName: accountName,
            completefunc: function(xData, Status) {
                $(xData.responseXML).SPFilterNode("PropertyData").each(function() {
                    userData[$(this).find("Name").text()] = $(this).find("Value").text();
                });
            }
        });

        // return user's data with better property names
        return {
            "account": userData.AccountName,
            "name": userData.PreferredName,
            "email": userData.WorkEmail.toLowerCase(),
            "dept": userData.Department,
            "firstName": userData.FirstName,
            "lastName": userData.LastName,
            "phone": userData.WorkPhone,
            "userName": userData.UserName.toLowerCase(),
            "pictureURL": userData.PictureURL
        };
    };

	function ReturnThisEmployeeIsNOTEx (exEmployees, thisEmployee) {
		if (exEmployees.indexOf(thisEmployee) > -1) {
			return false;
		} else {
			return true;
		}
	}

	function ReturnNameOrReplacement(nameReplacements, thisName) {
		$.each(nameReplacements, function (i, nameReplacementObject) {
			if (nameReplacementObject.input == thisName) {
				thisName = nameReplacementObject.output;
			}
		});
		return thisName
	}

	function ReturnEmailOrReplacement(emailReplacements, thisName) {
		$.each(emailReplacements, function (i, emailReplacementObject) {
			if (emailReplacementObject.input == thisName) {
				thisName = emailReplacementObject.output;
			}
		});
		return thisName
	}

	function ReturnPeopleListFieldValue (email) {
		var fieldValue = "";
		if (typeof (email) == "string") {
			fieldValue = '-1;#' + email;
		}
		if (typeof (email) == "object") {
			var emailString = "";
			$.each(email, function (i, emailElement) {
				if (i != 0) {
					emailString += ";#";
				}
				emailString += '-1;#' + emailElement;
			});
			fieldValue = emailString;
		}
		return fieldValue;
	}

	function ReturnPeopleAllRequestDataValue (names, emails) {
		var ardValue = "";
		if (typeof (emails) == "string") {
			ardValue = '[{ "account": "i:0#.f|membership|' + emails + '", "displayText": "' + names + '", "description": "' + emails + '" }]';
		}
		if (typeof (emails) == "object") {
			var emailString = "[";
			$.each(emails, function (i, emailsElement) {
				if (i != 0) {
					emailString += ",";
				}
				emailString += '{ "account": "i:0#.f|membership|' + emails[i] + '", "displayText": "' + names[i] + '", "description": "' + emails[i] + '" }';
			});
			emailString += "]";
			ardValue = emailString;
		}
		return ardValue;
	}




	function ReturnFileSizeToReport (fileSizeInBytes) {

		// set up var
		var fileSizeToReport = "";


		// perform some file size conversions
		var fileSizeInKB = fileSizeInBytes / 1000;
		var fileSizeInMB = fileSizeInKB / 1000;
		var fileSizeInGB = fileSizeInMB / 1000;

		// set fileSizeToReport to the first file size conversion to be less than 4 digits
		if (Math.round(fileSizeInKB) > 0 && Math.round(fileSizeInKB) < 1000) {
			fileSizeToReport = fileSizeInKB;
			fileSizeToReport = $().ReturnFileSizeFormattedToOneSignificantDigit(fileSizeToReport);
			fileSizeToReport = fileSizeToReport + " KB";
		} else if (Math.round(fileSizeInMB) > 0 && Math.round(fileSizeInMB) < 1000) {
			fileSizeToReport = fileSizeInMB;
			fileSizeToReport = $().ReturnFileSizeFormattedToOneSignificantDigit(fileSizeToReport);
			fileSizeToReport = fileSizeToReport + " MB";
		} else if (Math.round(fileSizeInGB) > 0 && Math.round(fileSizeInGB) < 1000) {
			fileSizeToReport = fileSizeInGB;
			fileSizeToReport = $().ReturnFileSizeFormattedToOneSignificantDigit(fileSizeToReport);
			fileSizeToReport = fileSizeToReport + " GB";
		} else {
			fileSizeToReport = fileSizeInBytes + " bytes";
		}

		return fileSizeToReport;
	}

	function ReturnCurrencyStringFormatted (inputString) {
		var strippedString = inputString.replace("\$", "").replace(/[,]/g, "");
		if (strippedString == "") { 
			return "";
		} else {
			return numeral(parseFloat(strippedString)).format('$0,0.00');
		}
	}

	function ReturnFileTypeClass (fileName) {

		var fileTypeClass = "";

		// get file extension
		var fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1, fileName.length)

		if (fileExtension == "jpeg" || fileExtension == "jpg" || fileExtension == "png" || fileExtension == "gif") {
			fileTypeClass = "specific-image";
		} else if (fileExtension == "doc" || fileExtension == "docx" || fileExtension == "dot" || fileExtension == "dotx") {
			fileTypeClass = "word-file";
		} else if (fileExtension == "xls" || fileExtension == "xlsx" || fileExtension == "xlsm" || fileExtension == "xlm") {
			fileTypeClass = "excel-file";
		} else if (fileExtension == "ppt" || fileExtension == "pptx") {
			fileTypeClass = "powerpoint-file";
		} else if (fileExtension == "pdf") {
			fileTypeClass = "pdf-file";
		} else if (fileExtension == "psd") {
			fileTypeClass = "psd-file";
		} else if (fileExtension == "tiff") {
			fileTypeClass = "tiff-file";
		} else if (fileExtension == "ai") {
			fileTypeClass = "ai-file";
		} else if (fileExtension == "eps") {
			fileTypeClass = "eps-file";
		} else if (fileExtension == "svg") {
			fileTypeClass = "svg-file";
		} else if (fileExtension == "txt") {
			fileTypeClass = "text-file";
		} else {
			// console.log("indeterminate file type");
			// console.log(fileName);
			fileTypeClass = "generic-file";
		}

		return fileTypeClass;
	}

	function HtmlEncode(str) {
		return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;');
		// .replace(/'/g, '&#39;')
		// .replace(/</g, '&lt;')
		// .replace(/>/g, '&gt;');
	}

	function CDataWrap(value) {
		return "<![CDATA[" + value + "]]>";
	}


	function StrInStr(haystack, needle, bool) {

		var pos = 0;
		haystack += '';
		pos = haystack.toLowerCase()
			.indexOf((needle + '')
				.toLowerCase());

		if (pos == -1) {
			return false;
		} else {
			if (bool == 1) {
				return haystack.substr(0, pos);
			} else {
				return haystack.slice(pos);
			}
		}
	}

	function SendErrorEmail(from, to, body, subject) {

		var siteurl = _spPageContextInfo.webServerRelativeUrl;

		var urlTemplate = siteurl + "/_api/SP.Utilities.Utility.SendEmail";
		$.ajax({
			contentType: 'application/json',
			url: urlTemplate,
			type: "POST",
			data: JSON.stringify({
				'properties': {
					'__metadata': { 'type': 'SP.Utilities.EmailProperties' },
					'From': from,
					'To': { 'results': [to] },
					'Body': body,
					'Subject': subject
				}
			}
			),
			headers: {
				"Accept": "application/json;odata=verbose",
				"content-type": "application/json;odata=verbose",
				"X-RequestDigest": $("#__REQUESTDIGEST").val()
			},
			success: function (data) {
			},
			error: function (err) {
				console.log('SendErrorEmail also had an error: ' + JSON.stringify(err));
			}
		});


	}

</script>



<!-- all content -->
<div id="all-content-container"></div>