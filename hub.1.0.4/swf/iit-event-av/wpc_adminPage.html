
<script type="text/javascript">

    $(document).ready(function () {

        // maintenance mode
        var allSWFsInMaintenance = $().ReturnMaintenanceModeAllSWFs();
        var thisSWFInMainenanceMode = $().ReturnMaintenanceModeThisSWF(location);
        if (allSWFsInMaintenance == false && thisSWFInMainenanceMode == false) {

            console.log("using admin2 5");
            moment.locale('en');
            moment.suppressDeprecationWarnings = true;

            // get / set mData
            mData = $().ReturnThisSiteSettings();
            mData.componentGroupID = 3;
            mData = $.extend(
                $().GetFieldsFromOneRow({
                    "listName": "ComponentLog",
                    "select": [{
                        "nameHere": "returnURI",
                        "nameInList": "URIAdmin",
                        "linkField": 1
                    }, {
                        "nameHere": "formURI",
                        "nameInList": "URIRequest",
                        "linkField": 1
                    }, {
                        "nameHere": "componentAdmin",
                        "nameInList": "AdminAccess"
                    }, {
                        "nameHere": "requestName",
                        "nameInList": "RequestName"
                    }],
                    "where": {
                        "field": "ComponentID",
                        "type": "Number",
                        "value": mData.componentID,
                    }
                }),
                $().GetFieldsFromOneRow({
                    "listName": "Component Group Log",
                    "select": [{
                        "nameHere": "componentGrpAdmin",
                        "nameInList": "GroupAdminAccess"
                    }],
                    "where": {
                        "field": "ComponentGroupID",
                        "type": "Number",
                        "value": mData.componentGroupID,
                    }
                }),
                mData
            );

            // get / set user data
            var uData = $().ReturnCurrentUserData();
            uData.isAdmin = $().UserIsComponentAdmin(uData);
            uData.isComponentGrpAdmin = $().UserIsComponentGrpAdmin(uData, mData.componentGroupID);
            if (uData.isComponentGrpAdmin == 1) { uData.isAdmin = 1; }


            // if user is not an admin
            if (uData.isAdmin == 0) {
                
                // render a permission denied message
                $('div#overlays-container').fadeIn(200);
                $('div#mos-form-no-view-permission').fadeIn(400);
                return;
            
            // if user is an admin
            } else {

                // get date params
                var startDateFrom = $().GetParamFromUrl(location.search, 'startDateFrom');
                var startDateTo = $().GetParamFromUrl(location.search, 'startDateTo');

                if (startDateFrom == "") {
                    startDateFrom = $().ReturnFormattedDateTime('nowLocal', null, 'YYYY-MM-DD');
                }

                if (startDateTo == "") {
                    startDateTo = moment(startDateFrom, 'YYYY-MM-DD').add(14, "days").format('YYYY-MM-DD');
                }

                // append no permission message
                $('div#overlays-container').append($().ReturnNoViewPermissionMessage());

                // add a class to #all-content-container to serve as styling hook
                $("div#all-content-container").addClass(ReplaceAll("\\.", "", ReplaceAll(" ", "-", mData.requestName)).toLowerCase());

                var tData = {
                    'commonColumns': [
                        {
                            'displayName': 'Request ID',
                            'internalName': 'ID',
                            'formLink': 1
                        }, {
                            'displayName': 'Requested By',
                            'internalName': 'Author',
                            'userName': 1
                        }, {
                            'displayName': 'Talk To',
                            'internalName': 'RequestedFor',
                            'userName': 1
                        }, {
                            'displayName': 'Event Start Date and Time',
                            'internalName': 'EventBeginningDatetime',
                            'groupingFriendlyFormatOnLoad': { 'incomingFormat': null, 'returnFormat': 'ddd, MMM D, YYYY', 'determineYearDisplayDynamically': 1 }
                        }, {
                            'displayName': 'Request Date',
                            'internalName': 'RequestDate',
                            'friendlyFormatOnLoad': { 'incomingFormat': null, 'returnFormat': 'MMMM D, YYYY', 'determineYearDisplayDynamically': 1 }
                        }
                    ],
                    'tables': [
                        {
                            'tableID': 'pending-approval',
                            'someColsAreUsers': 1,
                            'grouping': {
                            	'zeroIndexedColumnNumber': 3,
                            	'numberColsForHeaderToSpan': 4
                            },
                            'customCAMLQuery': '<Where>' +
                                                '   <And>' +
                                                '       <Eq>' +
                                                '           <FieldRef Name="RequestStatus"></FieldRef>' +
                                                '           <Value Type="Text">Pending Approval</Value>' +
                                                '       </Eq>' +
                                                '       <And>' +
                                                '           <Geq>' +
                                                '               <FieldRef Name="EventBeginningDatetime"></FieldRef>' +
                                                '               <Value Type="DateTime" IncludeTimeValue="FALSE">' + startDateFrom + 'T00:00:00Z</Value>' +
                                                '           </Geq>' +
                                                '           <Leq>' +
                                                '               <FieldRef Name="EventBeginningDatetime"></FieldRef>' +
                                                '               <Value Type="DateTime" IncludeTimeValue="FALSE">' + startDateTo + 'T00:00:00Z</Value>' +
                                                '           </Leq>' +
                                                '       </And>' +
                                                '   </And>' +
                                                '</Where>'
                        }, {
                            'tableID': 'approved',
                            'someColsAreUsers': 1,
                            'grouping': {
                            	'zeroIndexedColumnNumber': 3,
                            	'numberColsForHeaderToSpan': 6
                            },
                            'customCAMLQuery': '<Where>' +
                                                '   <And>' +
                                                '       <Eq>' +
                                                '           <FieldRef Name="RequestStatus"></FieldRef>' +
                                                '           <Value Type="Text">Approved</Value>' +
                                                '       </Eq>' +
                                                '       <And>' +
                                                '           <Geq>' +
                                                '               <FieldRef Name="EventBeginningDatetime"></FieldRef>' +
                                                '               <Value Type="DateTime" IncludeTimeValue="FALSE">' + startDateFrom + 'T00:00:00Z</Value>' +
                                                '           </Geq>' +
                                                '           <Leq>' +
                                                '               <FieldRef Name="EventBeginningDatetime"></FieldRef>' +
                                                '               <Value Type="DateTime" IncludeTimeValue="FALSE">' + startDateTo + 'T00:00:00Z</Value>' +
                                                '           </Leq>' +
                                                '       </And>' +
                                                '   </And>' +
                                                '</Where>',
                            'customColumns': [
                                {
                                    'displayName': 'Request ID',
                                    'internalName': 'ID',
                                    'formLink': 1
                                }, {
                                    'displayName': 'Requested By',
                                    'internalName': 'Author',
                                    'userName': 1
                                }, {
                                    'displayName': 'Talk To',
                                    'internalName': 'RequestedFor',
                                    'userName': 1
                                }, {
                                    'displayName': 'Event Date and Time',
                                    'internalName': 'EventBeginningDatetime',
                                    'groupingFriendlyFormatOnLoad': { 'incomingFormat': null, 'returnFormat': 'ddd, MMM D, YYYY', 'determineYearDisplayDynamically': 1 }
                                }, {
                                    'displayName': 'Request Date',
                                    'internalName': 'RequestDate',
                                    'friendlyFormatOnLoad': { 'incomingFormat': null, 'returnFormat': 'MMMM D, YYYY', 'determineYearDisplayDynamically': 1 }
                                }, {
                                    'displayName': 'Assigned To',
                                    'internalName': 'AssignedTo',
                                    'userName': 1
                                }, {
                                    'displayName': 'Assignment Date',
                                    'internalName': 'AssignmentDate',
                                    'friendlyFormatOnLoad': { 'incomingFormat': null, 'returnFormat': 'MMMM D, YYYY', 'determineYearDisplayDynamically': 1 }
                                }
                            ]
                        }, {
                            'tableID': 'closed',
                            'someColsAreUsers': 1,
                            'grouping': {
                            	'zeroIndexedColumnNumber': 4,
                            	'numberColsForHeaderToSpan': 9
                            },
                            'customCAMLQuery': '<Where>' +
                                                '   <And>' +
                                                '       <Eq>' +
                                                '           <FieldRef Name="EndOfLife"></FieldRef>' +
                                                '           <Value Type="Text">1</Value>' +
                                                '       </Eq>' +
                                                '       <And>' +
                                                '           <Geq>' +
                                                '               <FieldRef Name="EventBeginningDatetime"></FieldRef>' +
                                                '               <Value Type="DateTime" IncludeTimeValue="FALSE">' + startDateFrom + 'T00:00:00Z</Value>' +
                                                '           </Geq>' +
                                                '           <Leq>' +
                                                '               <FieldRef Name="EventBeginningDatetime"></FieldRef>' +
                                                '               <Value Type="DateTime" IncludeTimeValue="FALSE">' + startDateTo + 'T00:00:00Z</Value>' +
                                                '           </Leq>' +
                                                '       </And>' +
                                                '   </And>' +
                                                '</Where>',
                            'customColumns': [
                                {
                                    'displayName': 'Request ID',
                                    'internalName': 'ID',
                                    'formLink': 1
                                }, {
                                    'displayName': 'Request Status',
                                    'internalName': 'RequestStatus'
                                }, {
                                    'displayName': 'Requested By',
                                    'internalName': 'Author',
                                    'userName': 1
                                }, {
                                    'displayName': 'Talk To',
                                    'internalName': 'RequestedFor',
                                    'userName': 1
                                }, {
                                    'displayName': 'Event Date and Time',
                                    'internalName': 'EventBeginningDatetime',
                                    'groupingFriendlyFormatOnLoad': { 'incomingFormat': null, 'returnFormat': 'ddd, MMM D, YYYY', 'determineYearDisplayDynamically': 1 }
                                }, {
                                    'displayName': 'Request Date',
                                    'internalName': 'RequestDate',
                                    'friendlyFormatOnLoad': { 'incomingFormat': null, 'returnFormat': 'MMMM D, YYYY', 'determineYearDisplayDynamically': 1 }
                                }, {
                                    'displayName': 'Assigned To',
                                    'internalName': 'AssignedTo',
                                    'userName': 1
                                }, {
                                    'displayName': 'Assignment Date',
                                    'internalName': 'AssignmentDate',
                                    'friendlyFormatOnLoad': { 'incomingFormat': null, 'returnFormat': 'MMMM D, YYYY', 'determineYearDisplayDynamically': 1 }
                                }, {
                                    'displayName': 'Completed By',
                                    'internalName': 'CompletedBy',
                                    'userName': 1
                                }, {
                                    'displayName': 'Completion Date',
                                    'internalName': 'CompletionDate',
                                    'friendlyFormatOnLoad': { 'incomingFormat': null, 'returnFormat': 'MMMM D, YYYY', 'determineYearDisplayDynamically': 1 }
                                }
                            ]
                        }
                    ]
                };


                // insert container and sub-containers
                $("div#all-content-container").prepend( '<div id="container_command-bar-and-tables"> \n' + 
                                                        '   <div id="container_command-bar"></div> \n' + 
                                                        '   <div id="table-container"></div> \n' + 
                                                        '</div>' );
                console.log("mData");
                console.log(mData);
                // to do: make return on new request round-trip re: params
                // determine contents
                var commandBarContents =    '<h2 id="header_command-bar">Commands</h2> \n' + 
                                            '<div id="container_new-request-control"> \n' + 
                                            '   <a class="button-link button-link_new-item" href="' + mData.formURI + '?returnURI=' + window.location.href + '">new request</a> \n' + 
                                            '</div> \n' + 
                                            '<ul id="container_tab-controls"> \n' + 
                                            '   <li><a href="#table-container_pending-approval">pending approval</a></li> \n' + 
                                            '   <li><a href="#table-container_approved">approved</a></li> \n' + 
                                            '   <li><a href="#table-container_closed">closed</a></li> \n' + 
                                            '</ul> \n' + 
                                            '<div id="container_date-filter-controls-and-header"> \n' +
                                            '   <div id="text_date-filter-controls" class="collapsible">dates</div> \n' + 
                                            '   <div id="container_date-filter-controls"> \n' + 
                                            '        <div class="container_date-filter-control"> \n' +
                                            '            <label class="date-selector-label" for="start-date_from">Start Date From</label> \n' +
                                            '            <input class="date-selector" id="start-date_from" name="start-date_from" type="text"> \n' +
                                            '        </div> \n' +
                                            '        <div class="container_date-filter-control"> \n' +
                                            '            <label class="date-selector-label" for="start-date_to">Start Date To</label> \n' +
                                            '            <input class="date-selector" id="start-date_to" name="start-date_to" type="text"> \n' +
                                            '        </div> \n' +
                                            '        <div class="container_date-filter-control"> \n' +
                                            '            <a id="submit-button">Update</a> \n' +
                                            '        </div> \n' +
                                            '    </div> \n' +
                                            '</div> \n';

                
                $().RenderAllDataTables(tData, mData);

                // insert contents into containers
                $("div#container_command-bar").html(commandBarContents);
                
                // turn some command bar elements into tab controls and the turn the corresponding contents into tabbed content
                $("div#container_command-bar-and-tables").tabs();

                // set datepickers on date filter fields
                $("input.date-selector").datepicker({
                    changeMonth: "true",
                    changeYear: "true",
                    dateFormat: "MM d, yy"
                });

                // set currently-used dates into date fields
                $("input#start-date_from").val(moment(startDateFrom, 'YYYY-MM-DD').format('MMMM D, YYYY'));
                $("input#start-date_to").val(moment(startDateTo, 'YYYY-MM-DD').format('MMMM D, YYYY'));

                // listen for date filtering
                $("a#submit-button").click(function() {
                    
                    var startDateFromFieldValue = $("input#start-date_from").val();
                    var startDateToFieldValue = $("input#start-date_to").val();

                    if (startDateFromFieldValue == "") {
                        startDateFromFieldValue = $().ReturnFormattedDateTime('nowLocal', null, 'MMMM D, YYYY');
                    }

                    if (startDateToFieldValue == "") {
                        startDateToFieldValue = moment(startDateFromFieldValue, 'MMMM D, YYYY').add(14, "days").format('MMMM D, YYYY');
                    }

                    var newStartDateFrom = $().ReturnFormattedDateTime(startDateFromFieldValue, null, 'YYYY-MM-DD');
                    var newStartDateTo = $().ReturnFormattedDateTime(startDateToFieldValue, null, 'YYYY-MM-DD');

                    window.location = mData.uriAdmin + "?startDateFrom=" + newStartDateFrom + "&startDateTo=" + newStartDateTo;
                });
            }

        } else {
            $().RenderMaintenanceMessage();
        }
    });

</script>



<!-- all content -->
<div id="all-content-container">
</div>